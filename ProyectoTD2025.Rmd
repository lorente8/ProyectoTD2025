---
title: "ProyectoTD2025"
author: "Mar Alemany"
date: "2025-03-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introducción


cargamos las librerias necesarias:
```{r include=FALSE}
#Nos aseguramos de que no haya nada cargado en el Environment
rm(list=ls())

# Especificamos las librerías necesarias en esta lista
packages = c("knitr","tidyverse", "ggplot2", "dplyr", "pdftools", "stringr", "corrplot")
# Cargar los paquetes, sino están intalados, se instalarán automáticamente y serán cargados
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
    library(x, character.only = TRUE)
  }
})
```


Hemos cambiado los nombres a los archivos para que no den error con el siguiente codigo pero lo dejo como comentario para no sobreescribir los archivos al ejecutar mas de una vez: 
-----------------------------------------------------------------------------------
# Obtener lista de archivos PDF en la carpeta
archivos <- list.files(path =  "./data" , pattern = "\\.pdf$", full.names = FALSE, ignore.case = TRUE)

# Renombrar archivos secuencialmente
for (i in seq_along(archivos)) {
  nombre_actual <- file.path(ruta_carpeta, archivos[i])
  extension <- file_ext(archivos[i])
  nombre_nuevo <- file.path(ruta_carpeta, paste0("M", i, ".", extension))
  
  file.rename(from = nombre_actual, to = nombre_nuevo)
}
----------------------------------------------------------------------------------




# Importación de los datos

cargamos los archivos de la carpeta
```{r}
# Obtener lista de archivos PDF en la carpeta
archivos <- list.files(path =  "./data" , pattern = "\\.pdf$", full.names = TRUE, ignore.case = TRUE)
#print(archivos)
```



Definimos vectores para almacenar los datos de los tickets
```{r}
comercio <- c() #nombre del comercio
empresa <- c() #tipo y código de empresa
direccion <- c() 
cp <- c() #código postal
telefono <- c() #Misma línea, tendremos que separar estos valores
fecha <- c()
hora <- c()
op <- c()
fs <- c()#factura
productos <- c() #lista con los productos comprados
total <- c() #total de la compra
forma_pago <- c()

#IVA
base_imp <- c() #Base imponible
cuota <- c() #Cuota 

```


Extraemos la informacion de cada ticket y lo añadimos al vector correspondiente:
```{r}
for (archivo in archivos) {
  
  pdf <- pdf_text(archivo) #leemos le archivo pdf
  ticket <- trimws(strsplit(pdf,split = "\n")[[1]]) #separamos por líneas
  ticket <- ticket[grep(".", ticket)] #quitamos las líneas vacías

  #procesamos los datos del ticket
  linea_comercio <- ticket[1]
  linea_direccion <- ticket[2]
  linea_cp <- ticket[3]
  linea_telefono <- ticket[4]
  linea_fecha_hora_op <- ticket[5]
  linea_fs <- ticket[6]
  p = 8 
  linea_productos <- ticket[p]
    #unimos todos los productos en un solo caracter
  while (ticket[p+1] != ticket[grep("TOTAL", ticket)[1]]){
    p = p + 1
    linea_productos <- paste(linea_productos, ticket[p],sep = ";")
  }
  linea_total <- ticket[grep("TOTAL", ticket)[1]]
  linea_forma_pago <- ticket[p+2]
  linea_iva <- ticket[grep("TOTAL", ticket)[2]]
  
  #extaremos los datos
  com <- strsplit(linea_comercio,", ")[[1]]
  comercio <- c(comercio, com[1])
  empresa <- c(empresa, com[2])
  direccion <- c(direccion, trimws(linea_direccion))
  cp_info <- strsplit(trimws(linea_cp), " ")[[1]]
  cp <- c(cp, cp_info[1])
  telefono <- c(telefono, trimws(gsub("TELÉFONO:", "", linea_telefono)))
  fecha_hora_op <- strsplit(trimws(linea_fecha_hora_op), " ")[[1]]
  fecha_hora_op <- fecha_hora_op[grep(".", fecha_hora_op)]
  fecha <- c(fecha, fecha_hora_op[1])
  hora <- c(hora, fecha_hora_op[2])
  op <- c(op, gsub("OP:", "", fecha_hora_op[4]))
  fs <- c(fs, gsub("FACTURA SIMPLIFICADA:", "", linea_fs))
  productos <- c(productos, linea_productos)
  total <- c(total, trimws(gsub("TOTAL [(]€[)]", "", linea_total)))
  formapago <- strsplit(linea_forma_pago," ")[[1]]
  forma_pago <- c(forma_pago, paste0(formapago[1],formapago[2]))
  base_couta <- strsplit(trimws(linea_iva),split = " ")[[1]]
  base_couta <- base_couta[grep(".", base_couta)]
  base_imp <- c(base_imp,base_couta[2])
  cuota <- c(cuota, base_couta[3])
  
}
```


Creamos un data frame con los datos:
```{r}
df <- data.frame(comercio, empresa, direccion, cp, telefono, fecha, hora, 
                 op, fs, productos, total, forma_pago, base_imp, cuota,
                 stringsAsFactors = FALSE)

#Modificamos las clases de los datos
df$fecha <- as.Date(df$fecha,format = "%d/%m/%Y")
df$anio <- as.numeric(format(df$fecha, "%Y"))
df$mes <- as.numeric(format(df$fecha, "%m"))
df$dia <- as.numeric(format(df$fecha, "%d"))
# Elimina la columna fecha
df$fecha <- NULL

# Separar la columna fs en tres partes
fs_split <- strsplit(df$fs, "-")
# Crear las nuevas columnas a partir del resultado
df$num_tienda <- sapply(fs_split, function(x) x[1])
df$num_caja <- sapply(fs_split, function(x) x[2])
df$num_ticket <- sapply(fs_split, function(x) x[3])
# Eliminar la columna original fs
df$fs <- NULL
df$comercio <- NULL
df$empresa <- NULL


df$total <- as.numeric(gsub(pattern = ",",replacement = ".",df$total))
df$base_imp <- as.numeric(gsub(pattern = ",",replacement = ".",df$base_imp))
df$cuota <- as.numeric(gsub(pattern = ",",replacement = ".",df$cuota))
```

# Analizamos los productos

En el df estan toda la informacion relativa a los productos en la columna producto la separamos en un nuevo dataframe con df_producto
```{r}
df_producto <- df %>% select(c(num_ticket, productos)) %>% 
  separate_rows(productos, sep = ";")
```


#procesamiento de pescado por kg

Primero nos encargamos de los productos de pesacdao que aparecen con este format:
- Primera fila del pescado: Solo dice "PESCADO" 
- Segunda fila: Nombre del producto 
-Tercera fila: Detalles del precio 

```{r}
# Identificar filas con "PESCADO"
filas_pescado <- which(df_producto$productos == "PESCADO")

# Inicializar vectores para almacenar datos
num_ticket_vec <- character()
nombre_producto_vec <- character()
peso_kg_vec <- numeric()
precio_kg_vec <- numeric()
precio_total_vec <- numeric()

for (i in seq_along(filas_pescado)) {
  idx <- filas_pescado[i]
  
  # Extraer información básica
  num_ticket <- df_producto$num_ticket[idx]
  nombre_producto <- df_producto$productos[idx + 1]  # Nombre en la siguiente fila
  
  # Procesar la fila de detalles (ej: "0.390 kg 6.95 €/kg 2.71")
  detalles <- df_producto$productos[idx + 2]
  
  # Limpiar y dividir la cadena de detalles
  detalles_limpio <- gsub(",", ".", detalles)  # Reemplazar comas por puntos
  detalles_split <- strsplit(trimws(detalles_limpio), "\\s+")[[1]]
  
  # Extraer valores (asumiendo orden: peso, unidad, precio_kg, moneda, precio_total)
  if (length(detalles_split) >= 5) {
    peso_kg <- as.numeric(detalles_split[1])
    precio_kg <- as.numeric(detalles_split[3])
    precio_total <- as.numeric(detalles_split[5])
    
    # Almacenar en vectores
    num_ticket_vec <- c(num_ticket_vec, num_ticket)
    nombre_producto_vec <- c(nombre_producto_vec, nombre_producto)
    peso_kg_vec <- c(peso_kg_vec, peso_kg)
    precio_kg_vec <- c(precio_kg_vec, precio_kg)
    precio_total_vec <- c(precio_total_vec, precio_total)
  }
}

# Crear dataframe con cbind (column-wise)
df_pescado <- data.frame(
  num_ticket = num_ticket_vec,
  nombre_producto = nombre_producto_vec,
  peso_kg = peso_kg_vec,
  precio_kg = precio_kg_vec,
  precio_total = precio_total_vec,
  stringsAsFactors = FALSE
)

# Verificar resultados
head(df_pescado)
```


#Procesamiento fruta y la verdura

borrar primero las filas de pescado para asegurarte de que los productos restantes vendidos por kg sean exclusivamente fruta y verdura. 

```{r}
# Paso 1: Identificar TODOS los bloques de pescado (3 filas cada uno)
bloques_pescado <- which(df_producto$productos == "PESCADO")

# Crear vector con TODAS las filas a eliminar (cada bloque son 3 filas)
filas_a_eliminar <- unlist(lapply(bloques_pescado, function(x) x:(x+2)))

# Verificación previa
cat("\nFilas a eliminar (primer bloque como ejemplo):\n")
print(df_producto[bloques_pescado[1]:(bloques_pescado[1]+2), ])

# Paso 2: Eliminar COMPLETAMENTE todos los bloques
df_sin_pescado <- df_producto[-filas_a_eliminar, ]

# Verificación exhaustiva
if(any(df_sin_pescado$productos == "PESCADO")) {
  cat("\n¡ADVERTENCIA! Quedaron filas de pescado:\n")
  print(df_sin_pescado[df_sin_pescado$productos == "PESCADO", ])
} else {
  cat("\n✓ Eliminación CORRECTA: 0 filas de pescado restantes\n")
}

# Paso 3: Continuar con tu procesamiento normal...
# [Aquí iría tu código para procesar frutas/verduras y otros productos]
```

```{r}
df_fruta_verdura <- data.frame(
  num_ticket = df_sin_pescado$num_ticket[ind_detalles_kg],
  nombre = df_sin_pescado$productos[ind_detalles_kg - 1],
  detalles = df_sin_pescado$productos[ind_detalles_kg],
  stringsAsFactors = FALSE
) %>%
mutate(
  # Limpiar el nombre (eliminar números iniciales)
  nombre = gsub("^\\d+\\s*", "", nombre),
  
  # Extraer peso (kg) - primer número en la línea
  peso_kg = as.numeric(gsub(",", ".", str_extract(detalles, "^[0-9,]+"))),
  
  # Extraer precio por kg - método mejorado
  precio_kg = as.numeric(gsub(",", ".", 
    str_extract(detalles, "[0-9,]+(?=\\s*€/kg)"))),
  
  # Extraer importe total - último número en la línea
  importe = as.numeric(gsub(",", ".", 
    str_extract(detalles, "[0-9,]+$")))
) %>%
select(-detalles)

# Verificación de NAs
if(any(is.na(df_fruta_verdura$precio_kg))) {
  cat("\n¡Atención! Se encontraron NAs en precio_kg. Ejemplos problemáticos:\n")
  print(df_fruta_verdura[is.na(df_fruta_verdura$precio_kg), ])
} else {
  cat("\n✓ Todos los precios por kg se extrajeron correctamente\n")
  print(head(df_fruta_verdura))
}
```



#resto de productos sin kg

Extraemos cantidad descripcion y precio
```{r}
df_producto <- df_producto %>%
  mutate(productos_lista = strsplit(gsub("\\s+", " ", productos), "\\s+", perl=TRUE))

# Extraer cantidad, descripción y precio
cantidad <- sapply(df_producto$productos_lista, function(x) as.numeric(x[1]))
descripcion <- sapply(df_producto$productos_lista, function(x) 
  {if (x[1]=="1") {
    paste(x[2:(length(x)-1)], collapse = " ")
  } else{
    n <- as.integer(x[1])
    if (n>1 && is.na(n) == FALSE){
      paste(x[2:(length(x)-2)], collapse = " ")
    }else{
      paste(x[2:(length(x)-1)], collapse = " ")
    }
    }
  }
    )
importe <- sapply(df_producto$productos_lista, 
                   function(x) as.numeric(gsub(",", ".", x[length(x)])))
precio_unidad <- importe/cantidad

#Añadimos las nuevas columnas al data frame
df_producto <- cbind(df_producto,cantidad, descripcion, precio,importe)
```

hacemos un df con la informacion de pescado
```{r}
# Primero identificamos las líneas que contienen "PESCADO" o el patrón de código
lineas_pescado <- grep("PESCADO|\\d+-\\d+-\\d+", df_producto$productos, value = TRUE, ignore.case = TRUE)

# Creamos un dataframe para el pescado
df_pescado <- df_producto[grep("PESCADO|\\d+-\\d+-\\d+", df_producto$productos, ignore.case = TRUE), ]

```






